package main

import (
	"fmt"
	"log"
	"time" // –î–æ–±–∞–≤–∏–ª–∏ time

	"golang.zx2c4.com/wintun"
)

func main() {
	// 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
	// –ò—Å–ø–æ–ª—å–∑—É–µ–º nil –¥–ª—è GUID, —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π —Ä–∞–∑ —Å–æ–∑–¥–∞–≤–∞–ª—Å—è "—á–∏—Å—Ç—ã–π" –∞–¥–∞–ø—Ç–µ—Ä
	adapter, err := wintun.CreateAdapter("MyVPN", "Example", nil)
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∞–¥–∞–ø—Ç–µ—Ä–∞: %v", err)
	}
	defer adapter.Close()

	fmt.Println("‚úÖ –°–µ—Ç–µ–≤–æ–π –∞–¥–∞–ø—Ç–µ—Ä 'MyVPN' —Å–æ–∑–¥–∞–Ω!")

	// --- –ò–ó–ú–ï–ù–ï–ù–ò–ï: –£–±—Ä–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π netsh ---
	// Windows —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–¥–ª–µ–Ω–Ω–æ. –î–∞–¥–∏–º –µ–π 2 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã –æ—Å–æ–∑–Ω–∞—Ç—å, —á—Ç–æ –∞–¥–∞–ø—Ç–µ—Ä –ø–æ—è–≤–∏–ª—Å—è.
	time.Sleep(2 * time.Second)

	fmt.Println("‚è≥ –ñ–¥—É –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ IP... (–°–¥–µ–ª–∞–π —ç—Ç–æ –≤—Ä—É—á–Ω—É—é!)")

	// 2. –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Å—Å–∏—é
	session, err := adapter.StartSession(0x800000)
	if err != nil {
		log.Fatalf("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞ —Å–µ—Å—Å–∏–∏: %v", err)
	}
	defer session.End()

	fmt.Println("üöÄ –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–ª—É—à–∞–µ—Ç! –¢–µ–ø–µ—Ä—å –Ω–∞—Å—Ç—Ä–æ–π IP –≤ –¥—Ä—É–≥–æ–º –æ–∫–Ω–µ.")

	// 3. –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª —á—Ç–µ–Ω–∏—è
	for {
		packet, err := session.ReceivePacket()
		if err != nil {
			// –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Ñ–∞—Ç–∞–ª—å–Ω–∞—è - –≤—ã—Ö–æ–¥–∏–º, –∞ –Ω–µ —Å–ø–∞–º–∏–º –≤ –∫–æ–Ω—Å–æ–ª—å
			log.Println("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è (–ê–¥–∞–ø—Ç–µ—Ä –æ—Ç–∫–ª—é—á–µ–Ω?):", err)
			time.Sleep(1 * time.Second) // –ü–∞—É–∑–∞ —á—Ç–æ–±—ã –Ω–µ –≤–µ—à–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä
			continue
		}

		// –ö–æ–ø–∏—Ä—É–µ–º –ø–∞–∫–µ—Ç
		packetCopy := make([]byte, len(packet))
		copy(packetCopy, packet)
		session.ReleaseReceivePacket(packet)

		fmt.Printf("üì• –ü–æ–π–º–∞–Ω –ø–∞–∫–µ—Ç! –†–∞–∑–º–µ—Ä: %d –±–∞–π—Ç\n", len(packetCopy))
	}
}
